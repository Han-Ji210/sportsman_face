<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <title>
        나와 닮은 운동선수 찾기
    </title>  
  </head>
  <body>
    <button type="button" id="start-button" onclick="init()">예측 모델 불러오기</button>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <div class="file-upload">
      <button class="file-upload-btn" type="button" onclick="$('.file-upload-input').trigger('click')">사진 추가</button>
      <div class="image-upload-wrap">
        <input class="file-upload-input" type="file" onchange="readURL(this);" accept="image/*" />
        <div class="drag-text">
          <h3>파일을 드래그하여 업로드하거나 사진 추가 버튼을 클릭하세요.</h3>
        </div>
      </div>
      <div class="file-upload-content">
        <img class="file-upload-image" id="face-image" src="#" alt="사진" />
        <div class="image-title-wrap">
          <button type="button" onclick="removeUpload()" class="remove-image">삭제 <span class="image-title">업로드된 사진</span></button>
        </div>
      </div>
    </div>
    <button type="button" id="predict-button" onclick="predict()">예측</button>
    <div id="label-container" class="result-box">
      당신과 닮은 스포츠 선수는???
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script>
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function (e) {
            $('.image-upload-wrap').hide();

            $('.file-upload-image').attr('src', e.target.result);
            $('.file-upload-content').show();

            $('.image-title').html(input.files[0].name);
          };

          reader.readAsDataURL(input.files[0]);
        } else {
          removeUpload();
        }
      }


      function removeUpload() {
        $('.file-upload-input').replaceWith($('.file-upload-input').clone());
        $('.file-upload-content').hide();
        $('.image-upload-wrap').show();
      }

      const URL = 'https://teachablemachine.withgoogle.com/models/HsPtWtP0z/';
      let model, labelContainer, maxPredictions;

      async function init() {
        const startButton = document.getElementById('start-button');
        startButton.disabled = true;
        startButton.innerHTML = 'Loading...';

        const modelURL = URL + 'model.json';
        const metadataURL = URL + 'metadata.json';

        try {
          model = await tmImage.load(modelURL, metadataURL);
          maxPredictions = model.getTotalClasses();

          labelContainer = document.getElementById('label-container');
          for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement('div'));
          }

          startButton.style.display = 'none';
        } catch (error) {
          console.error('Error loading model:', error);
          startButton.innerHTML = 'Failed';
        }
      }

      function predict() {
        const predictButton = document.getElementById('predict-button');
        predictButton.innerHTML = 'Predicting...';

        var originalImage = document.getElementById('face-image');

        var grayImage = new Image();
        grayImage.onload = function() {
          model.predict(grayImage, false).then((prediction) => {
            let maxIndex = 0;
            let maxProbability = prediction[0].probability;
            for (let i = 1; i < prediction.length; i++) {
              if (prediction[i].probability > maxProbability) {
                maxIndex = i;
                maxProbability = prediction[i].probability;
              }
            }

            const maxClassLabel = prediction[maxIndex].className;

            labelContainer.innerHTML = `${(maxProbability).toFixed(2)*100}% ${maxClassLabel} 선수와 닮았습니다!`;

            $('.result-box').slideUp(500, function() {
              setTimeout(function() {
                $('.result-box').slideDown(500);
              }, 500);
            }); 

            predictButton.innerHTML = '예측 완료';
          });
        };
        makeGray(originalImage, grayImage); 
      }

      function makeGray(originalImage, grayImage) {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = originalImage.width;
        canvas.height = originalImage.height;
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;

        for (var i = 0; i < data.length; i += 4) {
          var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
          data[i] = avg;
          data[i + 1] = avg;
          data[i + 2] = avg;
        }

        ctx.putImageData(imageData, 0, 0);

        grayImage.src = canvas.toDataURL();
      }

    
    </script>
  </body>
</html>
