<!DOCTYPE html>
<html>
	<head>
		<style>
			h1 {
				color: black;
				text-align: center;
				text-shadow: 4px 4px 6px gray;
				font-size: 50px;
			}
			#start-button,
			#predict-button {
				display: block;
				width: 20vw;
				margin: 0 auto;
				color: #fff;
				background: #33cc00;
				border: none;
				padding: 10px;
				border-radius: 4px;
				border-bottom: 4px solid #339900;
				outline: none;
				font-weight: 600;
			}

			#start-button:hover,
			#predict-button:hover {
				background-color: #45a049;
			}
		</style>
		<tittle>
			<h1>
				나와 닮은 운동선수 찾기
			</h1>
		</tittle>
	</head>
</html>
<html>
	<head>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
			<button type="button" id="start-button" onclick="init()">예측 모델 불러오기</button>
		<script
			class="jsbin"
			src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"
		></script>
		<div class="file-upload">
			<button
				class="file-upload-btn"
				type="button"
				onclick="$('.file-upload-input').trigger( 'click' )"
			>
				Add Image
			</button>

			<div class="image-upload-wrap">
				<input
					class="file-upload-input"
					type="file"
					onchange="readURL(this);"
					accept="image/*"
				/>
				<div class="drag-text">
					<h3>Drag and drop a file or select add Image</h3>
				</div>
			</div>
			<div class="file-upload-content">
				<img class="file-upload-image" id="face-image" src="#" alt="your image" />
				<div class="image-title-wrap">
					<button type="button" onclick="removeUpload()" class="remove-image">
						Remove <span class="image-title">Uploaded Image</span>
					</button>
				</div>
			</div>
		</div>
		<button type="button" id="predict-button" onclick="predict()">예측</button>

		<div id="label-container"></div>

		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
		<script>
			function readURL(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();

					reader.onload = function (e) {
						$('.image-upload-wrap').hide();

						$('.file-upload-image').attr('src', e.target.result);
						$('.file-upload-content').show();

						$('.image-title').html(input.files[0].name);
					};

					reader.readAsDataURL(input.files[0]);
				} else {
					removeUpload();
				}
			}

			function removeUpload() {
				$('.file-upload-input').replaceWith($('.file-upload-input').clone());
				$('.file-upload-content').hide();
				$('.image-upload-wrap').show();
			}

			$('.image-upload-wrap').bind('dragover', function () {
				$('.image-upload-wrap').addClass('image-dropping');
			});

			$('.image-upload-wrap').bind('dragleave', function () {
				$('.image-upload-wrap').removeClass('image-dropping');
			});

			const URL = 'https://teachablemachine.withgoogle.com/models/HsPtWtP0z/';

			let model, labelContainer, maxPredictions;

			async function init() {
				const startButton = document.getElementById('start-button');
				startButton.disabled = true;
				startButton.innerHTML = 'Loading...';

				const modelURL = URL + 'model.json';
				const metadataURL = URL + 'metadata.json';

				try {
					model = await tmImage.load(modelURL, metadataURL);
					maxPredictions = model.getTotalClasses();

					labelContainer = document.getElementById('label-container');
					for (let i = 0; i < maxPredictions; i++) {
						labelContainer.appendChild(document.createElement('div'));
					}

					startButton.style.display = 'none';
				} catch (error) {
					console.error('Error loading model:', error);
					startButton.innerHTML = 'Failed';
				}
			}

			
			function predict() {
				const predictButton = document.getElementById('predict-button');
				predictButton.innerHTML = 'Predicting...';

				var image = document.getElementById('face-image');

				makeGray(image);

				model.predict(image, false).then((prediction) => {
					let maxIndex = 0;
					let maxProbability = prediction[0].probability;
					for (let i = 1; i < prediction.length; i++) {
						if (prediction[i].probability > maxProbability) {
							maxIndex = i;
							maxProbability = prediction[i].probability;
						}
					}

					const maxClassLabel = prediction[maxIndex].className;

					labelContainer.innerHTML = `Predicted Class: ${maxClassLabel} (Probability: ${maxProbability.toFixed(
						2
					)})`;

					/*if (maxClassLabel.includes('양궁')) {
						document.body.style.backgroundColor = '#111111';
					} else if (maxClassLabel.includes('축구')) {
						document.body.style.backgroundColor = '#444444';
					} else if (maxClassLabel.includes('농구')) {
						document.body.style.backgroundColor = '#777777';
					} else if (maxClassLabel.includes('야구')) {
						document.body.style.backgroundColor = '#AAAAAA';
					} else if (maxClassLabel.includes('롤')) {
						document.body.style.backgroundColor = '#FFFFFF';
					}*/

					predictButton.innerHTML = '예측';
				});
			}

			function makeGray(image) {
				var canvas = document.createElement('canvas');
				var ctx = canvas.getContext('2d');
				canvas.width = image.width;
				canvas.height = image.height;
				ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;

				for (var i = 0; i < data.length; i += 4) {
					var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
					data[i] = avg; // red
					data[i + 1] = avg; // green
					data[i + 2] = avg; // blue
				}

				ctx.putImageData(imageData, 0, 0);
				image.src = canvas.toDataURL();
			}
		</script>
	</body>
</html>